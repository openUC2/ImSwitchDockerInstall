# Use an appropriate base image for Jetson Nano
# sudo docker build -t imswitch_daheng .
# docker run -it --rm --privileged imswitch_daheng
FROM ubuntu:22.04

ARG TARGETPLATFORM
ENV TZ=America/Los_Angeles
ENV DEBIAN_FRONTEND=noninteractive

# Set timezone to avoid interactive prompt
RUN ln -fs /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone

# Install necessary dependencies
RUN apt-get update && apt-get install -y \
    wget \
    unzip \
    python3 \
    python3-pip \
    usbutils \
    sudo \
    nano \
    git \
    expect

# Create the udev rules directory
RUN mkdir -p /etc/udev/rules.d

# Download and install the appropriate Daheng driver based on architecture
RUN cd /tmp && \
    wget https://dahengimaging.com/downloads/Galaxy_Linux_Python_2.0.2106.9041.tar_1.gz && \
    ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ]; then \
        DAHENG_ZIP="Galaxy_Linux-armhf_Gige-U3_32bits-64bits_1.5.2303.9202.zip" && \
        DAHENG_URL="https://github.com/openUC2/ImSwitchDockerInstall/releases/download/imswitch-master/${DAHENG_ZIP}" && \
        DAHENG_DIR="Galaxy_Linux-armhf_Gige-U3_32bits-64bits_1.5.2303.9202"; \
    elif [ "$ARCH" = "x86_64" ]; then \
        DAHENG_ZIP="Galaxy_Linux-x86_Gige-U3_32bits-64bits_2.4.2503.9201.zip" && \
        DAHENG_URL="https://dahengimaging.com/downloads/${DAHENG_ZIP}" && \
        DAHENG_DIR="Galaxy_Linux-x86_Gige-U3_32bits-64bits_2.4.2503.9201"; \
    else \
        DAHENG_ZIP="Galaxy_Linux-armhf_Gige-U3_32bits-64bits_1.5.2303.9202.zip" && \
        DAHENG_URL="https://github.com/openUC2/ImSwitchDockerInstall/releases/download/imswitch-master/${DAHENG_ZIP}" && \
        DAHENG_DIR="Galaxy_Linux-armhf_Gige-U3_32bits-64bits_1.5.2303.9202"; \
    fi && \
    wget "$DAHENG_URL" && \
    unzip "$DAHENG_ZIP" && \
    tar -zxvf Galaxy_Linux_Python_2.0.2106.9041.tar_1.gz && \
    cd "$DAHENG_DIR" && \
    chmod +x Galaxy_camera.run && \
    cd /tmp/Galaxy_Linux_Python_2.0.2106.9041/api && \
    python3 setup.py build && \
    python3 setup.py install && \
    echo "Y En Y" | "/tmp/$DAHENG_DIR/Galaxy_camera.run"

# Set environment variable for library path (will be set at runtime based on architecture)
# Note: The actual path will be determined by the architecture detected during build

RUN pip install pillow numpy

# Source the bashrc file
RUN echo "source ~/.bashrc" >> ~/.bashrc
RUN /bin/bash -c "source ~/.bashrc"

CMD /bin/bash
#  sudo python3 /tmp/Galaxy_Linux_Python_2.0.2106.9041/sample/GxSingleCamMono/GxSingleCamMono.py
